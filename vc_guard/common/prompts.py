from langchain_core.prompts import HumanMessagePromptTemplate

"""
该文件存放整个 demo 项目所有的提示词信息
变量名统一为 function_name + [other_msg] + template
"""

parse_user_prompt_template = HumanMessagePromptTemplate.from_template("""
用户输入为: {user_input}
你需要把用户输入解析成位置地点，位置经纬度，以及任务信息
可以调用工具来根据位置返回对应经纬度。
""")

get_best_vehicle_id_list_template = HumanMessagePromptTemplate.from_template("""
## 角色定位与核心任务
你作为智能车辆调度规划师，需基于给定地图信息为拍摄任务筛选最优车辆并派遣。核心目标是：结合观测象限规避原则，在任务地点附近选定新终点，从可用车辆中筛选符合要求的车辆前往，最终返回车辆ID及对应终点坐标。

## 核心规则（象限与终点坐标）
1. 象限划分与规避原则
以拍摄任务地点为中心，地图被划分为四个象限，对应关系如下：左下象限（索引0）、左上象限（索引1）、右上象限（索引2）、右下象限（索引3）。
调度优先级：优先选择未观测过的象限派遣车辆，避免重复观测，确保所选车辆对应的象限尽可能多样化，不局限于单一象限。

2. 终点坐标选定规范
需在任务地点坐标（i,j）附近选定新终点，且新坐标需与任务地点处于对应象限的对角线上，坐标偏移规则固定如下：
- 左上象限：（i-1, j-1）、（i-2, j-2）等（沿左上对角线延伸）；
- 右上象限：（i-1, j+1）、（i-2, j+2）等（沿右上对角线延伸）；
- 左下象限：（i+1, j-1）、（i+2, j-2）等（沿左下对角线延伸）；
- 右下象限：（i+1, j+1）、（i+2, j+2）等（沿右下对角线延伸）。
示例：若任务地点坐标为（12,13），选择左上象限终点，可设为（11,12）、（10,11）等。
特殊情况：若所有象限（0-3）均已观测，则随机选择任一象限，按上述规则选定终点后派遣车辆。

## 任务基础信息
调度需基于以下信息执行：
- 当前地图信息：{grid_matrix}（0=障碍，1=通路，其他数字=道路拥堵程度，数字越大拥堵越严重）；
- 已观测象限列表：{observed_quadrant}；
- 拍摄任务地点坐标：{task_location}（先行后列，符合二维数组表示规范）；
- 需选择车辆数量：{num_of_vehicles}；
- 可用车辆列表：{agent_card_models}（含车辆ID、状态、距离、速度等信息）。

## 车辆筛选规则（按优先级排序）
1. 优先级1：优先选择距离拍摄任务地点较近的车辆；
2. 优先级2：在距离相近的车辆中，选择速度适中的车辆；
3. 范围限制：提供的可用车辆中选择，严禁虚构车辆 ID；
4. 路径说明：无需计算精准最优路径，仅依据上述规则大致评估即可。

## 输出要求
最终返回两组列表，数量需与所需车辆数量一致：
- 车辆 ID 列表：所选车辆的唯一标识集合；
- 对应终点坐标列表：每辆车需前往的终点坐标（先行后列）。

特殊场景处理：
- 若可用车辆总数少于所需车辆数量，则返回全部可用车辆的 ID 及对应终点坐标；
- 若无可用车辆，直接返回空列表（车辆 ID 列表为空，坐标列表亦为空）。
""")

handle_image_observation_template = HumanMessagePromptTemplate.from_template("""
现有车辆观测图片，请你根据本次的任务：{task_description}，把图片内容总结成文本。
注意，仅总结和任务相关的信息。最终回复的文本不要包含 Markdown 形式，仅文字内容即可。
""")

handle_text_observation_template = HumanMessagePromptTemplate.from_template("""
现有车辆在任务路段位置: {task_location} 的观测信息。请你根据本次的任务：{task_description}，总结出本次的观测结果以及对应的证据，形成报告。
此外，本次观测的其他额外信息: 任务 id: {task_id}, 车辆 id: {car_id}, 车辆朝向: {car_direction}, 观测时间: {observation_timestamp} 也一并纳入报告中。
在报告的总结中，请着重强调车辆的朝向以及对应的路段，可以把对应的 0-360 的角度转换为东南西北等方向来描述。
""")

multi_view_understanding_template = HumanMessagePromptTemplate.from_template("""
现有车辆报告信息: {simple_report_list}，以及你自己的报告信息: {self_report}。
请你根据本次的任务：{task_description}，参考别的车辆的报告，尝试检查并修正自己的结果。
注意，如果其他车辆的报告内容和你自己负责的报告内容，不一致，可以不参考。
例如：你自己的报告中观测的是某路段的东侧，车辆 A 的报告观测的是路段东侧，B 车辆的报告观测的是路段西侧，那么你可以参考 A 的报告，B 的就不需要关注了。
仅修正你自己报告信息中的 result 和 evidence 字段，其他字段不变。
返回最终的报告。
""")

summary_template = HumanMessagePromptTemplate.from_template("""
现有所有的车辆报告信息: {report_list}，以及本次任务的任务描述: {task_description}，任务 id: {task_id}。
请你总结本次任务的结果，并返回总结。在总结中需要注明路段信息，以及对应位置的情况。
""")

multi_view_understanding_summary_template = HumanMessagePromptTemplate.from_template("""
现有车辆报告信息: {simple_report_list}。任务 id: {task_id}。
请你根据本次的任务：{task_description}，参考这些车辆的报告，进行多视角理解。例如：车辆 A、C 的报告显示路段东侧有违停情况，B 显示路段东侧看不到任何信息，那么你应该参考 A、C 的报告，B 的就不需要关注了。
返回最终的报告。在总结中需要注明路段信息，以及对应位置的情况。
""")

llm_judge_template = HumanMessagePromptTemplate.from_template("""
你是根因分析有效性检测工具，仅需输出 "CONTINUE" 或 "STOP"，无任何额外文字、标点或解释。
## 被检测的任务描述: {task_description}
## 检测规则
1. 有效根因分析（输出 STOP）：报告中指出了形成问题的原因
2. 无效根因分析（输出 CONTINUE）：
   - 无问题形成的根因分析；
   - 根因分析存在明显逻辑错误。

## 待检测内容
{final_report}
""")

evaluate_summary_template = HumanMessagePromptTemplate.from_template("""
你是计算机领域专注于城市市容管理智能检测的学术评审专家，精通目标检测结果的语义一致性与有效性评估。
你的核心任务是基于以下明确标准和目标检测场景，对智能体的检测结果进行客观量化评分，仅输出0.0-10.0的浮点分数（保留1位小数），不添加任何额外文本、格式或解释。

## 1. 目标检测场景定义举例（必须严格遵循）
- garbage：违规场景为“路段周围垃圾违规堆放造成异味”，核心判定要素：是否存在垃圾堆积（含溢出垃圾桶、散落地面）、垃圾是否与异味存在直接关联；
- illegal_parking：违规场景为“违规停车造成车辆拥堵”，核心判定要素：是否存在违规停车行为、违规停车是否与车辆拥堵存在直接关联。

## 2. 评估维度与量化标准（总分10.0分）
### 维度1：准确性（4.0分）
- 4.0分：检测结论与场景定义完全一致（存在违规则明确对应核心要素，不存在违规则判断依据充分）；
- 2.0-3.5分：检测结论基本符合场景定义，但核心要素描述模糊（如未明确垃圾堆积位置、未说明违规停车与拥堵的关联）；
- 0.0-1.5分：检测结论与场景定义不符（如垃圾场景误判为其他污染源、违规停车场景未识别拥堵关联）或存在明显错误。

### 维度2：完整性（3.0分）
- 3.0分：完整包含核心要素的关键信息（垃圾场景：位置+垃圾类型+异味关联；违规停车场景：位置+停车数量+拥堵影响）；
- 1.5-2.5分：包含部分关键信息（如仅说明存在垃圾堆积，未提及异味来源）；
- 0.0-1.0分：未包含核心要素的关键信息（如仅说“存在异味”，未提及垃圾）。

### 维度3：相关性（2.0分）
- 2.0分：描述完全围绕场景核心要素，无无关信息（如垃圾场景不冗余提及车辆排气、工厂排放等非核心内容）；
- 1.0分：描述以核心要素为主，但包含少量无关信息；
- 0.0分：描述重点偏离场景核心要素，无关信息占比超50%。

### 维度4：明确性（1.0分）
- 1.0分：结论清晰明确（明确“存在”或“不存在”违规，无模糊表述）；
- 0.0分：结论模糊（如“可能存在异味”“疑似违规停车”等不确定表述）。

## 3. 评分规则
1. 先根据检测结果的“违规存在状态”（存在/不存在），对应场景核心要素逐项匹配，分别计算四个维度得分，总分=各维度得分之和；
2. 若检测结果未提及场景核心要素（如垃圾场景未提“垃圾”，违规停车场景未提“违规停车”），直接判0.0分；
3. 分数保留1位小数，如9.5、3.0、0.5（禁止整数形式如10，需写10.0）。

已知目标检测场景：{target_task}
智能体检测结果：{summary}
""")